import {
  DifferentialSample,
  SwerveSample,
  Trajectory
} from "../document/schema/DocumentTypes";

export const TRAJ_DATA_FILENAME = "ChoreoTrajectories";

function round(val: number, digits: number) {
  const roundingFactor = Math.pow(10, digits);
  return Math.round(val * roundingFactor) / roundingFactor;
}

function formatPose(sample: SwerveSample | DifferentialSample): string {
  const x = round(sample.x, 3);
  const y = round(sample.y, 3);
  const heading = round(sample.heading, 3);
  return `new Pose2d(${x}, ${y}, Rotation2d.fromRadians(${heading}))`;
}

function sanitizeTrajName(trajName: string): string {
  let newName = trajName;
  for (let i = 0; i < newName.length; i++) {
    const char = newName.charAt(i);
    if (char !== " ") continue;
    newName =
      newName.slice(0, i) +
      newName.charAt(i + 1).toUpperCase() +
      newName.slice(i + 2);
  }
  newName = newName.replaceAll(/[^\w|^$]/g, "");
  if (newName.charAt(0).match(/[0-9]/)) {
    newName = "_" + newName;
  }
  return newName;
}

export function genTrajDataFile(
  trajectories: Trajectory[],
  packageName: string
): string {
  try {
    const content: string[] = [];
    const usedVarNames: Record<string, number> = {};
    content.push(`package ${packageName};`);
    content.push(`
import edu.wpi.first.math.geometry.Pose2d;
import edu.wpi.first.math.geometry.Rotation2d;

import java.util.Map;

/**
 * A class containing the start pose, end pose, and total time of every Choreo trajectory.
 * This allows for your robot code to access this data without overhead from parsing JSON.
 * DO NOT MODIFY THIS FILE YOURSELF! It is automatically generated by Choreo.
 */

    public enum ${TRAJ_DATA_FILENAME} {`);

    const mapData: string[] = [];
    for (const traj of trajectories) {
      let varName = sanitizeTrajName(traj.name);
      const dupeCount = usedVarNames[varName];
      if (dupeCount > 0) {
        varName += `_${dupeCount}`;
        usedVarNames[varName] = dupeCount + 1;
      } else {
        usedVarNames[varName] = 1;
      }
      const waypoints = traj.trajectory.samples;
      if (waypoints.length === 0) {
        continue;
      }
      mapData.push(
        `      ${varName}(
          "${traj.name}",
          ${waypoints[waypoints.length - 1].t},
          ${formatPose(waypoints[0])},
          ${formatPose(waypoints[waypoints.length - 1])}
        )
    `.trimEnd()
      );
    }
    content.push(mapData.join(",\n"));
    content.push(`;
      public final String filename;
      public final double totalTimeSecs;
      public final Pose2d initialPoseBlue;
      public final Pose2d endPoseBlue;
      private ${TRAJ_DATA_FILENAME}(String name, double totalTimeSecs, Pose2d initialPoseBlue, Pose2d endPoseBlue) {
        this.filename = name;
        this.totalTimeSecs = totalTimeSecs;
        this.initialPoseBlue = initialPoseBlue;
        this.endPoseBlue = endPoseBlue;
      }
    };
  `);
    return content.join("\n");
  } catch (e) {
    console.error("Error generating trajectory data file:", e);
    throw e;
  }
}
